name: Nightly Build

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  JAVA_VERSION: '17'

jobs:
  nightly-tests:
    name: Nightly Full Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 5

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        timeout-minutes: 10
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean build
        run: ./gradlew clean --no-daemon

      - name: Full test suite
        run: ./gradlew test --no-daemon --info

      - name: Generate comprehensive reports
        run: ./gradlew test jacocoTestReport --no-daemon || true

      - name: Upload nightly reports
        if: always()
        uses: actions/upload-artifact@v4
        timeout-minutes: 5
        continue-on-error: true
        with:
          name: nightly-reports-${{ github.run_number }}
          path: |
            build/reports/
            build/test-results/
          retention-days: 90

  dependency-update-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 5

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        timeout-minutes: 10
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check for dependency updates
        run: |
          ./gradlew dependencyUpdates --no-daemon || echo "Dependency check completed"
          echo "Dependency update check would generate a report here"

      - name: Upload dependency reports
        if: always()
        uses: actions/upload-artifact@v4
        timeout-minutes: 5
        continue-on-error: true
        with:
          name: dependency-updates-${{ github.run_number }}
          path: build/dependencyUpdates/
          retention-days: 30

